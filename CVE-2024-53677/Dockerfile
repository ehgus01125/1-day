FROM openjdk:17-jdk-alpine AS builder
RUN apk add --no-cache maven
COPY ../struts-app /usr/src/cve
WORKDIR /usr/src/cve
RUN mvn clean package

FROM tomcat:9.0

RUN rm -rf /usr/local/tomcat/webapps/ \
 && mv /usr/local/tomcat/webapps.dist/ /usr/local/tomcat/webapps/ \
 && rm -rf /usr/local/tomcat/webapps/ROOT

COPY --from=builder /usr/src/cve/target/upload-1.0.0.war \
     /usr/local/tomcat/webapps/ROOT.war

COPY catalina.sh               /usr/local/tomcat/bin/catalina.sh
COPY tomcat-users.xml          /usr/local/tomcat/conf/tomcat-users.xml
COPY context.xml               /usr/local/tomcat/webapps/manager/META-INF/context.xml

RUN chmod +x /usr/local/tomcat/bin/catalina.sh

EXPOSE 8080

# Tomcat 실행
CMD ["/usr/local/tomcat/bin/catalina.sh", "run"]

